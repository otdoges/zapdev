# Authentication Fix - November 13, 2025

## Issue Summary

**Problem**: WebSocket authentication failures with error: `"No auth provider found matching the given token"`

**Error Details**:
```
Failed to authenticate: "No auth provider found matching the given token. 
Check that your JWT's issuer and audience match one of your configured providers: 
[OIDC(domain=https://api.stack-auth.com/api/v1/projects/b8fa06ac-b1f5-4600-bee0-682bc7aaa2a8, app_id=convex)]"
```

**Root Cause**: Mixed authentication configuration in Convex deployment - both Clerk and Stack Auth environment variables were present, causing JWT validation conflicts.

---

## Fix Applied

### Environment Variables Removed from Convex

Successfully removed obsolete authentication variables from the dev deployment (`dependable-trout-339`):

1. ✅ `CLERK_JWT_ISSUER_DOMAIN`
2. ✅ `CLERK_SECRET_KEY`
3. ✅ `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`
4. ✅ `BETTER_AUTH_SECRET`
5. ✅ `BETTER_AUTH_URL`

### Current Stack Auth Configuration

The following Stack Auth variables are now the **only** authentication configuration in Convex:

- ✅ `NEXT_PUBLIC_STACK_PROJECT_ID=b8fa06ac-b1f5-4600-bee0-682bc7aaa2a8`
- ✅ `NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY=pck_...`
- ✅ `STACK_SECRET_SERVER_KEY=ssk_...`

These match the configuration in:
- `convex/auth.config.ts` (expects Stack Auth provider)
- `.env.local` (local development)
- Convex deployment environment

---

## Next Steps to Complete the Fix

### 1. Restart Convex Dev Server

The environment changes are applied, but you need to restart the Convex dev server:

```bash
# Kill the existing Convex dev server (Ctrl+C in that terminal)
# Then restart:
bun run convex:dev
```

### 2. Clear Browser Data

Clear authentication state in your browser:

**Option A - Clear for localhost:3000 only:**
1. Open DevTools (F12)
2. Application tab → Storage → Clear site data
3. Or manually clear:
   - Cookies for `localhost:3000`
   - LocalStorage for `localhost:3000`
   - SessionStorage for `localhost:3000`

**Option B - Use incognito/private browsing:**
- Open a new incognito window to test with fresh state

### 3. Test Authentication Flow

1. Navigate to `http://localhost:3000`
2. Click Sign Up → Go to `/handler/sign-up`
3. Create a test account with Stack Auth
4. Verify:
   - ✅ No WebSocket errors in console
   - ✅ User profile appears in navbar
   - ✅ Can create a new project
   - ✅ `projects:createWithMessageAndAttachments` succeeds

### 4. Monitor Console

Check for successful authentication:
```
✅ WebSocket connected (no reconnection loops)
✅ No "Failed to authenticate" errors
✅ No "Unauthorized" errors from Convex mutations
```

---

## Why This Fixed the Issue

### Before (Broken):
```
Client → Sends JWT token
         ↓
Convex → Checks auth.config.ts (expects Stack Auth)
         ↓
Convex → Sees BOTH Clerk AND Stack Auth env variables
         ↓
Convex → JWT validation confusion/mismatch
         ↓
Error: "No auth provider found"
```

### After (Fixed):
```
Client → Sends Stack Auth JWT token
         ↓
Convex → Checks auth.config.ts (expects Stack Auth)
         ↓
Convex → Only sees Stack Auth env variables
         ↓
Convex → JWT validates successfully
         ↓
Success: User authenticated
```

---

## Technical Details

### Authentication Flow

**Stack Auth Integration:**
1. Frontend uses `@stackframe/stack` hooks (`useUser()`, `useStackApp()`)
2. Stack Auth handles JWT generation and cookie management
3. ConvexClientProvider configures client with `stackApp.getConvexClientAuth({})`
4. Server-side uses `StackServerApp` with `tokenStore: "nextjs-cookie"`
5. Convex validates JWT against `auth.config.ts` providers

**JWT Validation:**
- Issuer must match: `https://api.stack-auth.com/api/v1/projects/b8fa06ac-b1f5-4600-bee0-682bc7aaa2a8`
- Application ID must match: `convex`
- Token must be signed with Stack Auth's keys

### Files Involved

**Convex Configuration:**
- `convex/auth.config.ts` - Stack Auth provider setup
- `convex/helpers.ts` - Uses `ctx.auth.getUserIdentity()`
- `convex/projects.ts` - Mutations require authentication

**Frontend:**
- `src/components/convex-provider.tsx` - Convex + Stack Auth integration
- `src/lib/auth-server.ts` - Server-side Stack Auth utilities
- `src/middleware.ts` - Route protection (simplified for Stack Auth)

---

## Production Deployment Notes

If you need to deploy to production (`agile-peccary-405`):

### Remove Old Variables from Production:
```bash
# Switch to production deployment first
convex deploy --prod

# Or set environment in Convex dashboard:
# https://dashboard.convex.dev
# Select production deployment → Settings → Environment Variables
# Remove: CLERK_*, BETTER_AUTH_*
```

### Verify Production Stack Auth Variables:
Make sure these are set in production:
- `NEXT_PUBLIC_STACK_PROJECT_ID`
- `NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY`
- `STACK_SECRET_SERVER_KEY`

---

## Rollback Plan

If you need to revert to Clerk (not recommended, Stack Auth is already implemented):

1. Restore Clerk environment variables:
   ```bash
   convex env set CLERK_JWT_ISSUER_DOMAIN <value>
   convex env set CLERK_SECRET_KEY <value>
   convex env set NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY <value>
   ```

2. Revert code to pre-Stack-Auth state:
   ```bash
   git log --oneline -20  # Find commit before Stack Auth migration
   git revert <commit-hash>
   ```

3. Reinstall Better Auth dependencies

---

## Verification Checklist

After restart and testing, verify:

- [ ] Convex dev server starts without errors
- [ ] No WebSocket reconnection loops in browser console
- [ ] Can access `/handler/sign-up` and create account
- [ ] Can sign in at `/handler/sign-in`
- [ ] User profile shows in navbar after login
- [ ] Can create new project (tests `createWithMessageAndAttachments`)
- [ ] No "Unauthorized" errors in Convex mutations
- [ ] Session persists across page reloads

---

## Related Documentation

- `STACK_AUTH_MIGRATION_COMPLETE.md` - Migration overview
- `explanations/STACK_AUTH_MIGRATION.md` - Detailed migration guide
- [Stack Auth Docs](https://docs.stack-auth.com/)
- [Stack Auth + Convex Integration](https://docs.stack-auth.com/docs/others/convex)

---

**Fix Applied By**: Claude AI Assistant  
**Date**: November 13, 2025  
**Status**: Environment cleaned up, restart required  
**Next Action**: Restart `bun run convex:dev` and test authentication flow
